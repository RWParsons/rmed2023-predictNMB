---
title: "predictNMB-demo"
author: "Rex Parsons"
format: gfm
bibliography: references.bib
---

```{r, echo=F}
set.seed(42)
```

If you haven't already, please install these packages
```{r, eval=F}
install.packages(c("predictNMB", "ggplot2", "purrr", "cowplot"))
```

```{r}
library(predictNMB)
library(ggplot2)
library(purrr)
library(cowplot)
library(parallel)
```


## Example problem and inputs required - inpatient falls

-   Falls leads to about 0.04 lost Quality-Adjusted Life Years (QALYs) [@latimer13] and has an approximate beta distribution of: $$\mathrm{B}(\alpha = 2.95, \beta = 32.25)$$\

-   There are also additional healthcare costs of about \$6669 [@morello2015extra] and follows an approximate gamma distribution of: $$\Gamma (\alpha = 22.05, \beta = 0.0033) $$

-   Fall prevention education...

    -   has a fixed, known cost of \$77.3 per patient [@hill2015fall]
    -   reduces probability of fall by 45% [@haines2011patient] - the log hazard ratio follows an approximate normal distribution of: $$\mathcal{N}(\mu = -0.844, \sigma = 0.304) $$

-   The willingness-to-pay (WTP) for us is \$28033 AUD

-   Current practice: Everyone gets the fall prevention intervention (treat-all approach).

Calculations and code for using details in paper cited papers above is described in [@parsons2023cutpoints].

## Objectives/Questions

-   We have a prediction model which has an AUC of about 0.8 and we want to know whether it'll be worthwhile implementing it within a CDSS to reduce healthcare costs (giving people that are unlikely to fall the intervention at \$77.3 a pop!)

-   We are currently in a geriatric ward where the fall rate is about 0.1 (1 in 10 admitted patients have a fall) but are also interested in implementing the same model in the acute care ward (fall rate = 0.03). Would we expect to make the same conclusion?

-   We think we can improve the performance of the model up to 0.95 with some extra effort by the models - would this change our conclusion?

## pre-`{predictNMB}` primer on the distributions we will be using.

We will be using different distributions to sample different inputs for our simulation. A gamma distribution is often appropriate when sampling \$ and a beta distribution is often best when sampling QALYs due to the shape and limits being sensible (the cost of treatment is unlikely be to be negative and QALYs are bounded to be between 0 and 1, similar to a probability of an event). We can sample from these distributions using R code with the `rgamma()` and `rbeta()` functions - for example, here are the distributions above for the healthcare costs and the QALYs associated with a fall:

```{r, message=FALSE}
data.frame(QALYs_lost = rbeta(10000, shape1 = 2.95, shape2 = 32.25)) |>
  ggplot(aes(x = QALYs_lost)) + 
  geom_histogram() +
  theme_bw()

data.frame(fall_costs = rgamma(10000, shape = 22.05, rate = 0.0033)) |>
  ggplot(aes(x = fall_costs)) + 
  geom_histogram() +
  theme_bw()
```

We will be using these sampling functions within our NMB sampling functions!

![](https://media1.giphy.com/media/7pHTiZYbAoq40/giphy.gif)

## `{predictNMB}`

## Making our samplers

```{r}
validation_sampler <- get_nmb_sampler(
  outcome_cost = function()  rgamma(1, shape = 22.05, rate = 0.0033),
  wtp = 28033,
  qalys_lost = function() rbeta(1, shape1 = 2.95, shape2 = 32.25),
  high_risk_group_treatment_effect = function() exp(rnorm(1, mean = -0.844, sd = 0.304)),
  high_risk_group_treatment_cost = 77.3,
  low_risk_group_treatment_effect = 0,
  low_risk_group_treatment_cost = 0,
  use_expected_values = FALSE
)


training_sampler <- get_nmb_sampler(
  outcome_cost = function()  rgamma(1, shape = 22.05, rate = 0.0033),
  wtp = 28033,
  qalys_lost = function() rbeta(1, shape1 = 2.95, shape2 = 32.25),
  high_risk_group_treatment_effect = function() exp(rnorm(1, mean = -0.844, sd = 0.304)),
  high_risk_group_treatment_cost = 77.3,
  low_risk_group_treatment_effect = 0,
  low_risk_group_treatment_cost = 0,
  use_expected_values = TRUE
)
```

## Primary analyses

### Running our simulation (primary use-case)

```{r}
cl <- makeCluster(detectCores() - 1)

primary_sim <- do_nmb_sim(
  n_sims = 500,
  n_valid = 10000,
  sim_auc = 0.8,
  event_rate = 0.1,
  cutpoint_methods = get_inbuilt_cutpoint_methods(),
  fx_nmb_training = training_sampler,
  fx_nmb_evaluation = validation_sampler,
  show_progress = TRUE,
  cl = cl
)
```

### Interpreting our results

```{r}
summary(primary_sim)

autoplot(primary_sim) + theme_sim()
autoplot(primary_sim, what = "cutpoints") + theme_sim()
autoplot(primary_sim, what = "inb", inb_ref_col = "all") + theme_sim()
autoplot(primary_sim, what = "qalys") + theme_sim()
autoplot(primary_sim, what = "costs") + theme_sim()

ce_plot(primary_sim, ref_col = "all", methods_order = c("all", "none", "youden", "value optimising"))
```

## Acute care setting?

```{r}
acute_care_sim <- do_nmb_sim(
  n_sims = 500,
  n_valid = 10000,
  sim_auc = 0.8,
  event_rate = 0.03,
  cutpoint_methods = get_inbuilt_cutpoint_methods(),
  fx_nmb_training = training_sampler,
  fx_nmb_evaluation = validation_sampler,
  show_progress = TRUE,
  cl = cl
)

summary(acute_care_sim)
summary(acute_care_sim, what = "cutpoints")
autoplot(acute_care_sim)

ce_plot(acute_care_sim, ref_col = "all", methods_order = c("all", "none", "youden", "value optimising"))
```

## What if we improve the model discrimination (AUC)?

```{r}
auc_screen <- screen_simulation_inputs(
  n_sims = 500,
  n_valid = 10000,
  sim_auc = seq(0.8, 0.95, 0.05),
  event_rate = 0.1,
  cutpoint_methods = get_inbuilt_cutpoint_methods(),
  fx_nmb_training = training_sampler,
  fx_nmb_evaluation = validation_sampler,
  show_progress = TRUE,
  cl = cl
)

autoplot(auc_screen, methods_order = c("all", "none", "youden", "value optimising"), dodge_width = 0.01)

map(1:4, \(x){
  ce_plot(auc_screen$simulations[[x]], ref_col = "all", methods_order = c("all", "none", "youden", "value optimising"))
}) |> 
  (\(x) {
    leg <- get_legend(x[[1]])
    new_plots <- map(x, function(x) x  + theme_bw() + theme(legend.position = "none") + xlab("Inc. Benefit (QALYs)")) 
    g <- plot_grid(plotlist = new_plots, ncol = 2, nrow = 2, labels = seq(0.8, 0.95, 0.05), label_y = 1.15) +
      theme(plot.margin = margin(1, 1, 1, 1, "cm"))
    plot_grid(g, leg, rel_widths = c(0.5, 0.1), nrow = 1) + theme(plot.margin = margin(r=1, unit="cm"))
  })()
```

# References
